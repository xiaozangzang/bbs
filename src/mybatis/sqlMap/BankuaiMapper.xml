<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="jbbs_bankuai" >
  <resultMap id="BaseResultMap" type="cc.javaee.bbs.model.Bankuai" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Feb 26 10:38:47 GMT+08:00 2017.
    -->
    
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="name" property="name" jdbcType="VARCHAR" />
    <result column="img" property="img" jdbcType="VARCHAR" />
    <result column="type" property="type" jdbcType="VARCHAR" />
    <result column="parentid" property="parentId" jdbcType="INTEGER" />
    <result column="orderby" property="orderBy" jdbcType="INTEGER" />
    <result column="createtime" property="createTime" jdbcType="VARCHAR" />
    <result column="createuserid" property="createUserid" jdbcType="INTEGER" />
  </resultMap>
  
  <select id="find" resultType="cc.javaee.bbs.model.Bankuai" parameterType="cc.javaee.bbs.model.Bankuai" >
    SELECT 	
	  t3.createtime tiezicreateTime,
	  t3.id tieziid,
	  t3.name tieziname,
	  t3.createuserid userid,
	  t4.loginname username,
	  t1.id,
	  t1.name,
	  t1.img,
	  t1.type,
	  t1.parentid,
	  t1.orderby,
	  t1.createtime createTime,
	  t1.createuserid,
	  t1.descs,
	  t1.fatiegroup,
	  t1.huifugroup,
	  (SELECT 
	    COUNT(*) 
	  FROM
	    jbbs_tiezi t2 
	  WHERE t1.id = t2.bankuai_id) zhuticount,
	  (SELECT COUNT(*) FROM jbbs_huifu tt1 LEFT JOIN jbbs_tiezi tt2 ON tt1.tieziid=tt2.id WHERE  t1.id = tt2.bankuai_id) huifucount
	FROM
	  jbbs_bankuai t1 
	  LEFT JOIN (SELECT MAX(id) id,bankuai_id FROM jbbs_tiezi GROUP BY bankuai_id) t2 ON t2.bankuai_id=t1.id
	  LEFT JOIN jbbs_tiezi t3 ON t3.id =t2.id
	  LEFT JOIN jbbs_user t4 ON t4.id=t3.createuserid
    where 1=1
    <if test="id != null" >
        and t1.id = #{id,jdbcType=INTEGER}
    </if>
    <if test="parentId != null" >
        and (t1.parentId = #{parentId,jdbcType=INTEGER} or  t1.id = #{parentId,jdbcType=INTEGER})
    </if>
    ORDER BY t1.orderby
  </select>
  
  
  <select id="findpage" resultType="cc.javaee.bbs.model.Bankuai" parameterType="cc.javaee.bbs.model.PageBean" >
   select  t1.id, t1.name, t1.img, t1.type, t1.orderby, t1.createtime createTime, t1.createuserid ,t1.parentid,t1.descs,
   	CASE t1.parentid
	WHEN '0' THEN 'æ— '
	ELSE t2.name END  parentname
    from jbbs_bankuai t1 LEFT JOIN  jbbs_bankuai t2 on t1.parentid=t2.id  where 1=1 
    <if test="bean.id != null" >
        and t1.id = #{bean.id,jdbcType=INTEGER}
    </if>
    <if test="bean.parentId != null" >
        and t1.parentId = #{bean.parentId,jdbcType=INTEGER}
    </if>
    ORDER BY t1.parentid, t1.orderby
    LIMIT ${pageNo}, ${pageSize}
  </select>
  <select id="findpagecount" resultType="java.lang.Integer" parameterType="cc.javaee.bbs.model.PageBean" >
    select 
    count(*)
    from jbbs_bankuai where 1=1 
    <if test="bean.id != null" >
        and id = #{bean.id,jdbcType=INTEGER}
    </if>
    <if test="bean.parentId != null" >
        and parentId = #{bean.parentId,jdbcType=INTEGER}
    </if>
  </select>
  <select id="findmaxorderby" resultType="java.lang.Integer" parameterType="java.lang.Integer" >
   SELECT COUNT(orderby)  FROM jbbs_bankuai WHERE  parentid = #{parentid,jdbcType=INTEGER}
  </select>
  
  
  <select id="findfbankuaibyid" resultType="cc.javaee.bbs.model.Bankuai" parameterType="java.lang.Integer" >
   SELECT 
	  t1.id,
	  t1.name,
	  t1.img,
	  t1.type,
	  t1.parentid,
	  t1.orderby,
	  t1.createtime createTime,
	  t1.createuserid,
	  t1.descs,
	  t1.fatiegroup,
	  t1.huifugroup,
	  t2.id fid,
	  t2.name fname 
	FROM
	  jbbs_bankuai t1 
	  LEFT JOIN jbbs_bankuai t2 
	    ON t1.parentid = t2.id 
     WHERE  t1.id = #{id,jdbcType=INTEGER}
  </select>
  
  
  
  <delete id="delete" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Feb 26 10:38:47 GMT+08:00 2017.
    -->
    delete from jbbs_bankuai
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="cc.javaee.bbs.model.Bankuai" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Feb 26 10:38:47 GMT+08:00 2017.
    -->
    insert into jbbs_bankuai
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="name != null" >
        name,
      </if>
      <if test="img != null" >
        img,
      </if>
      <if test="type != null" >
        type,
      </if>
      <if test="parentId != null" >
        parentid,
      </if>
      <if test="orderBy != null" >
        orderby,
      </if>
      <if test="createTime != null" >
        createtime,
      </if>
      <if test="createUserid != null" >
        createuserid,
      </if>
      <if test="descs != null" >
        descs,
      </if>
      <if test="fatiegroup != null" >
        fatiegroup,
      </if>
      <if test="huifugroup != null" >
        huifugroup,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="name != null" >
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="img != null" >
        #{img,jdbcType=VARCHAR},
      </if>
      <if test="type != null" >
        #{type,jdbcType=VARCHAR},
      </if>
      <if test="parentId != null" >
        #{parentId,jdbcType=INTEGER},
      </if>
      <if test="orderBy != null" >
        #{orderBy,jdbcType=INTEGER},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=VARCHAR},
      </if>
      <if test="createUserid != null" >
        #{createUserid,jdbcType=INTEGER},
      </if>
      <if test="descs != null" >
        #{descs,jdbcType=VARCHAR},
      </if>
      <if test="fatiegroup != null" >
        #{fatiegroup,jdbcType=VARCHAR},
      </if>
      <if test="huifugroup != null" >
        #{huifugroup,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="update" parameterType="cc.javaee.bbs.model.Bankuai" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sun Feb 26 10:38:47 GMT+08:00 2017.
    -->
    update jbbs_bankuai
    <set >
      <if test="name != null" >
        name = #{name,jdbcType=VARCHAR},
      </if>
      <if test="img != null" >
        img = #{img,jdbcType=VARCHAR},
      </if>
      <if test="type != null" >
        type = #{type,jdbcType=VARCHAR},
      </if>
      <if test="parentId != null" >
        parentid = #{parentId,jdbcType=INTEGER},
      </if>
      <if test="orderBy != null" >
        orderby = #{orderBy,jdbcType=INTEGER},
      </if>
      <if test="createTime != null" >
        createtime = #{createTime,jdbcType=VARCHAR},
      </if>
      <if test="createUserid != null" >
        createuserid = #{createUserid,jdbcType=INTEGER},
      </if>
      <if test="descs != null" >
        descs = #{descs,jdbcType=VARCHAR},
      </if>
      <if test="fatiegroup != null" >
        fatiegroup = #{fatiegroup,jdbcType=VARCHAR},
      </if>
      <if test="huifugroup != null" >
        huifugroup = #{huifugroup,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
</mapper>